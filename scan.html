<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan Jawaban Siswa</title>
  <style>
    canvas, video, img {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h3>Input Kunci Jawaban</h3>
  <textarea id="kunciJawaban" rows="3" cols="40" placeholder="Misal: A,B,C,D,A,..."></textarea>
  <button onclick="simpanKunci()">Simpan Kunci</button>

  <h3>Ambil Gambar</h3>
  <input type="file" accept="image/*" id="imageInput" capture="environment">
  <br>
  <img id="preview" style="display:none;">
  <canvas id="canvasOutput"></canvas>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <script>
    let kunci = [];

    function simpanKunci() {
      const input = document.getElementById("kunciJawaban").value;
      kunci = input.split(',').map(j => j.trim().toUpperCase());
      localStorage.setItem("kunciJawaban", JSON.stringify(kunci));
      alert("Kunci tersimpan");
    }

    function loadKunci() {
      const simpanan = localStorage.getItem("kunciJawaban");
      if (simpanan) {
        kunci = JSON.parse(simpanan);
        document.getElementById("kunciJawaban").value = kunci.join(',');
      }
    }

    function onOpenCvReady() {
      document.getElementById("imageInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        const img = document.getElementById("preview");
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          processImage(img);
        };
        img.style.display = "block";
      });
      loadKunci();
    }

    function processImage(imgElement) {
      let src = cv.imread(imgElement);
      let gray = new cv.Mat();
      let blur = new cv.Mat();
      let circles = new cv.Mat();

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 1.5, 1.5);
      cv.HoughCircles(blur, circles, cv.HOUGH_GRADIENT, 1, 20,
                      100, 30, 10, 30);

      for (let i = 0; i < circles.cols; ++i) {
        let x = circles.data32F[i * 3];
        let y = circles.data32F[i * 3 + 1];
        let radius = circles.data32F[i * 3 + 2];
        let center = new cv.Point(x, y);
        cv.circle(src, center, radius, new cv.Scalar(255, 0, 0, 255), 2);
      }

      cv.imshow("canvasOutput", src);
      src.delete(); gray.delete(); blur.delete(); circles.delete();
    }
  </script>
</body>
</html>
